<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zenoti-QuickBooks Integration</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.27.7/babel.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="root" class="container mx-auto p-4"></div>
  <div class="text-blue-500 p-4">Fallback: If you see this, index.html loaded but React failed.</div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    class ErrorBoundary extends React.Component {
      state = { error: null };
      static getDerivedStateFromError(error) {
        return { error: error.message };
      }
      render() {
        if (this.state.error) {
          return <div className="text-red-500 p-4">Error: {this.state.error}</div>;
        }
        return this.props.children;
      }
    }

    const App = () => {
      const [apiKey, setApiKey] = useState('');
      const [companyName, setCompanyName] = useState('');
      const [centers, setCenters] = useState([]);
      const [selectedCenter, setSelectedCenter] = useState('');
      const [authUrl, setAuthUrl] = useState('');
      const [status, setStatus] = useState('');
      const [isSyncing, setIsSyncing] = useState(false);

      const fetchCenters = async () => {
        try {
          const response = await fetch('/api/centers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ apiKey, companyName }),
          });
          const data = await response.json();
          if (data.centers) {
            setCenters(data.centers);
            setStatus('Centers loaded successfully.');
          } else {
            setStatus('Failed to load centers. Check API key.');
          }
        } catch (error) {
          setStatus('Error fetching centers: ' + error.message);
        }
      };

      const generateAuthLink = async () => {
        try {
          const response = await fetch('/api/auth-link', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ apiKey, companyName, centerId: selectedCenter }),
          });
          const data = await response.json();
          if (data.authUrl) {
            setAuthUrl(data.authUrl);
            setStatus('Authorization link generated. Click to connect QuickBooks.');
          } else {
            setStatus('Failed to generate auth link.');
          }
        } catch (error) {
          setStatus('Error generating auth link: ' + error.message);
        }
      };

      const triggerSync = async () => {
        setIsSyncing(true);
        try {
          const response = await fetch('/api/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ apiKey, companyName, centerId: selectedCenter }),
          });
          const data = await response.json();
          setStatus(data.message || 'Sync completed.');
        } catch (error) {
          setStatus('Error during sync: ' + error.message);
        } finally {
          setIsSyncing(false);
        }
      };

      return (
        <ErrorBoundary>
          <div className="max-w-2xl mx-auto bg-white p-6 rounded shadow">
            <h1 className="text-2xl font-bold mb-4">Zenoti-QuickBooks Integration</h1>
            <div className="mb-4">
              <label className="block text-sm font-medium">Company Name</label>
              <input
                type="text"
                value={companyName}
                onChange={(e) => setCompanyName(e.target.value)}
                className="mt-1 p-2 border rounded w-full"
                placeholder="Enter Company Name"
              />
            </div>
            <div className="mb-4">
              <label className="block text-sm font-medium">Zenoti API Key</label>
              <input
                type="text"
                value={apiKey}
                onChange={(e) => setApiKey(e.target.value)}
                className="mt-1 p-2 border rounded w-full"
                placeholder="Enter Zenoti API Key"
              />
            </div>
            <button
              onClick={fetchCenters}
              className="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 mb-4"
            >
              Load Centers
            </button>
            {centers.length > 0 && (
              <div className="mb-4">
                <label className="block text-sm font-medium">Select Center</label>
                <select
                  value={selectedCenter}
                  onChange={(e) => setSelectedCenter(e.target.value)}
                  className="mt-1 p-2 border rounded w-full"
                >
                  <option value="">Select a Center</option>
                  {centers.map((center) => (
                    <option key={center.id} value={center.id}>
                      {center.name}
                    </option>
                  ))}
                </select>
              </div>
            )}
            {selectedCenter && (
              <button
                onClick={generateAuthLink}
                className="bg-green-500 text-white p-2 rounded hover:bg-green-600 mb-4"
              >
                Generate QuickBooks Auth Link
              </button>
            )}
            {authUrl && (
              <div className="mb-4">
                <a
                  href={authUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-blue-500 underline"
                >
                  Connect to QuickBooks
                </a>
              </div>
            )}
            {selectedCenter && (
              <button
                onClick={triggerSync}
                disabled={isSyncing}
                className={`bg-purple-500 text-white p-2 rounded hover:bg-purple-600 ${
                  isSyncing ? 'opacity-50 cursor-not-allowed' : ''
                }`}
              >
                {isSyncing ? 'Syncing...' : 'Sync Data'}
              </button>
            )}
            {status && (
              <div className="mt-4 p-2 bg-gray-100 rounded">
                <p>{status}</p>
              </div>
            )}
          </div>
        </ErrorBoundary>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
